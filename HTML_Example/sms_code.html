<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Code</title>
    <style>
        #errorMessage {
            color: red;
            display: none; /* Скрыт по умолчанию */
        }
    </style>
</head>
<body>
    <h1>Введите код из СМС</h1>
    <form id="smsForm">
        <label for="sms_code">СМС-код:</label>
        <input type="text" id="sms_code" name="sms_code" required>
        <br>
        <button type="submit">Отправить</button>
    </form>

    <!-- Обратный отсчет -->
    <p id="countdown">Отправим код повторно через <span id="timer">30</span> секунд</p>

    <!-- Кнопка "Получить код заново" -->
    <button id="resendButton" style="display: none;">Отправить еще раз</button>

    <!-- Сообщение об ошибке -->
    <p id="errorMessage"></p>

    <!-- Кнопка для отключения (крестик) -->
    <button id="disconnectButton" style="position: fixed; top: 10px; right: 10px;">&#10006;</button>

    <script>
        let countdownInterval;

        // Функция для обновления таймера
        function updateTimer(timeLeft) {
            document.getElementById('timer').textContent = timeLeft;
            if (timeLeft <= 0) {
                document.getElementById('timer').textContent = 0;
                document.getElementById('resendButton').style.display = 'block';  // Показать кнопку
            } else {
                document.getElementById('resendButton').style.display = 'none';   // Скрыть кнопку до истечения таймера
            }
        }

        // Получаем таймер с бэкенда, чтобы синхронизироваться с таймером на сайте Тинькофф
        function fetchTimer() {
            fetch('http://127.0.0.1:8000/process/get_sms_timer/')  // Запрос на получение оставшегося времени до повторной отправки
                .then(response => response.json())
                .then(data => {
                    let timeLeft = data.time_left;
                    updateTimer(timeLeft);

                    // Обновляем таймер каждую секунду
                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        updateTimer(timeLeft);

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);  // Остановить таймер
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error('Ошибка при получении таймера:', error);
                });
        }

        // Загружаем таймер при загрузке страницы
        window.onload = fetchTimer;

        // Отправка СМС-кода
        document.getElementById('smsForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const smsCode = document.getElementById('sms_code').value;
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.style.display = 'none'; // Скрываем ошибку перед новой отправкой

            // Отправляем запрос на API через fetch
            fetch('http://127.0.0.1:8000/process/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(smsCode)
            })
            .then(response => response.json())
            .then(data => {
                // Очистка инпута
                document.getElementById('sms_code').value = '';

                const pageType = data.next_page_type;

                if (data.status === 'success') {
                    // Переход на следующую страницу
                    if (pageType === 'LOGIN_PASSWORD') {
                        window.location.href = './password.html';
                    } else if (pageType === 'LOGIN_CREATE_OTP') {
                        window.location.href = './create_otp.html';
                    } else if (pageType === 'EXPENSES') {
                        window.location.href = './expenses.html';
                    } else {
                        alert('Неизвестный тип страницы: ' + pageType);
                    }
                } else {
                    // Показываем сообщение об ошибке, если что-то не так
                    errorMessage.textContent = data.detail;
                    errorMessage.style.display = 'block';
                }
            })
            .catch(error => {
                // Очистка инпута
                document.getElementById('sms_code').value = '';

                console.error('Ошибка:', error);
                errorMessage.textContent = error;
                errorMessage.style.display = 'block';
            });
        });

        // Нажатие на кнопку "Отправить еще раз"
        document.getElementById('resendButton').addEventListener('click', function() {
            fetch('http://127.0.0.1:8000/process/resend_sms/', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                // Очистка инпута
                document.getElementById('sms_code').value = '';
                errorMessage.style.display = 'none'; // Скрываем ошибку

                if (data.status === 'success') {
                    // Скрыть кнопку и перезапустить отсчет
                    document.getElementById('resendButton').style.display = 'none';
                    document.getElementById('countdown').style.display = 'block';
                    fetchTimer();
                } else {
                    alert('Не удалось отправить код заново.');
                }
            })
            .catch(error => {
                console.error('Ошибка при повторной отправке:', error);
            });
        });

        // Кнопка "Крестик" для disconnect
        document.getElementById('disconnectButton').addEventListener('click', function() {
            fetch('http://127.0.0.1:8000/process/disconnect/', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                window.location.href = './index.html';  // Перенаправление на главную страницу после дисконнекта
            })
            .catch(error => {
                console.error('Ошибка при disconnect:', error);
            });
        });
    </script>
</body>
</html>
